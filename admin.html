            <!DOCTYPE html>
    <html lang="ar" dir="rtl">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø´ÙŠØ® Ø§Ù„Ø¨Ù„Ø¯</title>
        <!-- Fonts & Icons -->
        <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
        <link rel="stylesheet" href="permissions.css">
        <style>
            :root { 
                --primary: #b71c1c; --primary-dark: #8a1515; 
                --bg: #f3f4f6; --white: #ffffff; 
                --text: #1f2937; --text-light: #6b7280;
                --success: #10b981; --danger: #ef4444; --warning: #f59e0b; 
                --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                --radius: 12px;
            }
            * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Tajawal', sans-serif; -webkit-tap-highlight-color: transparent; }
            body { background: var(--bg); color: var(--text); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
            
            /* Login Screen */
            #login-page { 
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: linear-gradient(135deg, var(--primary), var(--primary-dark)); 
                z-index: 9999; display: flex; align-items: center; justify-content: center; 
            }
            .login-card {
                background: white; padding: 40px; border-radius: 20px; width: 100%; max-width: 360px;
                box-shadow: 0 20px 25px rgba(0, 0, 0, 0.2); text-align: center;
            }
            .login-card h2 { color: var(--primary); margin-bottom: 25px; font-weight: 900; }
            
            /* Dashboard Layout */
            #dashboard { display: none; height: 100vh; flex-direction: row; }
            
            /* Sidebar */
            .sidebar {
                width: 260px; background: white; height: 100%; border-left: 1px solid #e5e7eb;
                display: flex; flex-direction: column; padding: 20px 0; transition: 0.3s;
                z-index: 50; box-shadow: -2px 0 10px rgba(0,0,0,0.05);
            }
            .brand {
                padding: 0 24px 30px; font-size: 22px; font-weight: 900; color: var(--primary);
                display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #f3f4f6; margin-bottom: 10px;
            }
            .menu-item {
                padding: 14px 24px; margin: 4px 12px; border-radius: var(--radius);
                cursor: pointer; color: var(--text-light); display: flex; align-items: center; gap: 12px;
                font-weight: 500; transition: 0.1s;
            }
            .menu-item:hover { background: #f9fafb; color: var(--primary); }
            .menu-item.active { background: var(--primary); color: white; }
            
            .user-info { margin-top: auto; padding: 20px; border-top: 1px solid #eee; }
            
            /* Main Content */
            .main-content {
                flex: 1; overflow-y: auto; padding: 20px; position: relative; z-index: 10;
            }
            .top-bar {
                display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;
            }
            .page-title { font-size: 24px; font-weight: 800; }
            
            /* Mobile Toggle */
            .menu-toggle { display: none; font-size: 24px; cursor: pointer; color: var(--primary); z-index: 60; }
            
            /* Cards & Grids */
            .card { background: white; padding: 20px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 20px; border: 1px solid rgba(0,0,0,0.02); }
            .card h3 { font-size: 16px; color: var(--text-light); margin-bottom: 15px; border-bottom: 2px solid #f3f4f6; padding-bottom: 10px; }
            
            .grid-pos { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 20px; }
            .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
            .grid-cats { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
            
            /* Items */
            .item-card { 
                background: white; border: 1px solid #eee; border-radius: var(--radius); padding: 15px;
                text-align: center; cursor: pointer; transition: 0.1s; position: relative; overflow: hidden;
                touch-action: manipulation;
            }
            .item-card:active { transform: scale(0.95); background: #f9fafb; }
            .item-card.unavailable { opacity: 0.5; background: #f9fafb; pointer-events: none; }
            
            /* Category Tag */
            .cat-tag {
                background: #f3f4f6; color: var(--text); padding: 5px 10px; border-radius: 8px;
                display: inline-block; font-size: 13px; border: 1px solid #ddd; cursor: pointer;
            }
            
            /* Buttons & Inputs */
            .btn { border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; transition: 0.1s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
            .btn:active { transform: scale(0.95); }
            .btn-primary { background: var(--primary); color: white; }
            .btn-success { background: var(--success); color: white; }
            .btn-danger { background: var(--danger); color: white; }
            .btn-warning { background: var(--warning); color: white; }
            .btn-ghost { background: transparent; color: var(--text-light); }
            
            .input { 
                width: 100%; padding: 12px 15px; margin: 8px 0; border: 2px solid #e5e7eb; 
                border-radius: 10px; outline: none; transition: 0.2s; font-size: 14px; background: #f9fafb;
            }
            .input:focus { border-color: var(--primary); background: white; }
            
            /* Tables */
            /* ØªØ­Ø³ÙŠÙ† Ø´ÙƒÙ„ ÙƒØ§Ø±Øª Ø§Ù„Ø·Ø§ÙˆÙ„Ø© */
            .table-card {
                background: white;
                padding: 20px 15px;
                border-radius: var(--radius);
                text-align: center;
                border: 2px solid #eee;
                transition: 0.2s;
                display: flex;
                flex-direction: column;
                justify-content: space-between;
                min-height: 250px; /* ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø·ÙˆÙ„ */
                box-shadow: var(--shadow);
            }

            .table-card.active {
                border-color: var(--danger);
                background: #fffcfc;
            }

            .table-card h3 {
                font-size: 18px;
                color: var(--text);
                margin-bottom: 5px;
                border: none;
            }

            /* ØªÙ†Ø³ÙŠÙ‚ Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„ÙƒØ§Ø±Øª */
            .table-card .actions-container {
                display: flex;
                gap: 8px;
                justify-content: center;
                flex-wrap: wrap; /* Ø¹Ø´Ø§Ù† Ù„Ùˆ Ø§Ù„Ø´Ø§Ø´Ø© ØµØºØ±Øª ÙŠÙ†Ø²Ù„ÙˆØ§ ØªØ­Øª Ø¨Ø¹Ø¶ Ø¨Ø¯Ù„ Ù…Ø§ ÙŠØ¯Ø®Ù„ÙˆØ§ ÙÙŠ Ø¨Ø¹Ø¶ */
                margin-top: 15px;
            }

            .table-card .btn {
                padding: 8px 12px;
                font-size: 13px;
                flex: 1; /* Ø¹Ø´Ø§Ù† ÙŠØ§Ø®Ø¯ÙˆØ§ Ù…Ø³Ø§Ø­Ø§Øª Ù…ØªØ³Ø§ÙˆÙŠØ© */
                min-width: 45px;
            }

            .table-card .btn-ghost {
                background: #f9fafb;
                border: 1px solid #eee;
            }
            
            /* Stats */
            .stat-card { text-align: center; padding: 15px; border-radius: var(--radius); background: white; border: 1px solid #eee; }
            .stat-val { font-size: 24px; font-weight: 800; display: block; margin: 5px 0; }
            
            /* Floating Cart */
            #pos-cart {
                position: fixed; bottom: 0; left: 0; right: 0; background: white; padding: 15px 25px;
                border-top: 1px solid #eee; box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
                display: none; justify-content: space-between; align-items: center; z-index: 100; border-radius: 20px 20px 0 0;
            }
            
            /* Lock & Modal */
            #lock-screen, #history-modal {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8);
                z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(5px);
            }
            .modal-box {
                background: white; width: 90%; max-width: 450px; padding: 25px; border-radius: 20px;
                animation: slideUp 0.2s ease-out;
            }
            
            /* Utilities */
            .hidden { display: none !important; }
            /* Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª */
            .admin-only, .super-admin-only, .delete-btn { display: none !important; }
            /* Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Admin Ø£Ùˆ Super Admin ÙŠØ±Ù‰ Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­ÙƒÙ… */
            body.is-admin .admin-only { display: block !important; }
            body.is-admin .admin-only-inline { display: inline-flex !important; }
            /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ØªØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù„Ù€ Super Admin */
            body.is-super-admin .super-admin-only,
            body.is-super-admin .delete-btn { display: inline-flex !important; }
            /* Ø¥Ø®ÙØ§Ø¡ ÙƒØ§Ø±Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£ØµÙ†Ø§Ù Ø¹Ù† Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø¹Ø§Ø¯ÙŠÙŠÙ† */
            body.is-manager #tab-menu .card.admin-only { display: none !important; }

            /* Ø¥Ø®ÙØ§Ø¡ Ø¹Ø§Ù… */
            .delete-btn, .admin-only-inline.btn-danger {
                display: none !important;
            }

            /* Ø¥Ø¸Ù‡Ø§Ø± ÙÙ‚Ø· Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø£Ø¹Ù„Ù‰ */
            body.is-super-admin .delete-btn,
            body.is-super-admin .admin-only-inline.btn-danger {
                display: inline-flex !important;
            }

            /* ØªÙ†Ø³ÙŠÙ‚ Ø®Ø§Øµ Ø¨ØµÙØ­Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù„Ù…Ù†Ø¹ Ø§Ù„Ø§Ù†Ø¶ØºØ§Ø· */
            #tab-users .user-form-container {
                display: grid;
                grid-template-columns: 1fr 1fr; /* ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø³Ø·Ø± Ù„Ù†ØµÙÙŠÙ† */
                gap: 15px;
                margin-bottom: 15px;
            }

            #tab-users .input {
                width: 100% !important; /* Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ£Ø®Ø° Ù…Ø³Ø§Ø­ØªÙ‡ */
                margin: 5px 0;
            }

            #tab-users .btn-success {
                grid-column: span 2; /* Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© ÙŠØ£Ø®Ø° Ø§Ù„Ø³Ø·Ø± ÙƒØ§Ù…Ù„Ø§Ù‹ */
                padding: 15px;
            }

            .user-entry-card {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px;
                background: #fff;
                border: 1px solid #eee;
                border-radius: 10px;
                margin-bottom: 10px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            }

            /* Responsive */
            @media (max-width: 768px) {
                .sidebar { position: fixed; right: -280px; width: 280px; }
                .sidebar.show { right: 0; }
                .menu-toggle { display: block; }
                .grid-3 { grid-template-columns: 1fr; }
            }

            @media (max-width: 600px) {
                #tab-users .user-form-container { grid-template-columns: 1fr; }
                #tab-users .btn-success { grid-column: span 1; }
            }
            
            @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        </style>
    </head>
    <body>

        <!-- Login -->
        <div id="login-page">
            <div class="login-card">
                <div style="font-size: 40px; color: var(--primary); margin-bottom: 10px;"><i class="fas fa-utensils"></i></div>
                <h2>Ø´ÙŠØ® Ø§Ù„Ø¨Ù„Ø¯</h2>
                <input type="text" id="user" class="input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                <input type="password" id="pass" class="input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                <button class="btn btn-primary" style="width:100%; margin-top:15px; padding: 12px;" onclick="attemptLogin()">Ø¯Ø®ÙˆÙ„</button>
                <p id="login-msg" style="color: var(--danger); margin-top: 15px; font-size: 13px;"></p>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard">
            <!-- Sidebar -->
            <div class="sidebar" id="sidebar">
                <div class="brand">
                    <i class="fas fa-utensils"></i> Ø´ÙŠØ® Ø§Ù„Ø¨Ù„Ø¯
                </div>
                <div class="menu-item active" onclick="switchTab('pos')">
                    <i class="fas fa-cash-register"></i> Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹
                </div>
                <div class="menu-item" onclick="switchTab('cashier')">
                    <i class="fas fa-chair"></i> Ø§Ù„Ø·Ø§ÙˆÙ„Ø§Øª
                </div>
                <div class="menu-item" onclick="switchTab('menu')">
                    <i class="fas fa-hamburger"></i> Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                </div>
                <!-- NEW: Categories Tab -->
                <div class="menu-item admin-only" onclick="switchTab('categories')">
                    <i class="fas fa-tags"></i> Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
                </div>
                <div class="menu-item" onclick="switchTab('reports')">
                    <i class="fas fa-chart-pie"></i> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
                </div>
                <div class="menu-item admin-only" onclick="switchTab('users')">
                    <i class="fas fa-users-cog"></i> Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
                </div>
                
                <div class="user-info">
                    <div style="font-weight: bold;" id="user-display-name">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</div>
                    <small style="color: var(--text-light);" id="user-role-display">Ù…Ø¯ÙŠØ±</small>
                    <button class="btn btn-ghost btn-sm" onclick="logout()" style="width:100%; margin-top:10px; color: var(--danger);">
                        <i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬
                    </button>
                </div>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <div class="top-bar">
                    <div style="display:flex; align-items:center; gap:15px;">
                        <i class="fas fa-bars menu-toggle" onclick="toggleSidebar()"></i>
                        <h1 class="page-title" id="page-title">Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹</h1>
                    </div>
                    <div id="clock" style="color: var(--text-light); font-weight: bold;">00:00</div>
                </div>

                <!-- POS Tab -->
                <div id="tab-pos">
                    <div class="card" style="padding: 10px;">
                        <select id="pos-table" class="input" style="margin:0;"></select>
                    </div>
                    <div id="pos-menu-list" class="grid-pos"></div>
                </div>

                <!-- Cashier Tab -->
                <div id="tab-cashier" style="display:none;">
                    <!-- Ø³ÙŠØ¸Ù‡Ø± Ù‡Ø°Ø§ Ø§Ù„ÙƒØ§Ø±Øª ÙÙ‚Ø· Ù„Ù„Ù…Ø§Ù„Ùƒ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
                    <div class="card super-admin-only" style="padding: 15px;">
                        <button class="btn btn-primary" onclick="addNewTable()" style="width:100%"><i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ø·Ø§ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
                    </div>
                    <div id="tables-grid" class="grid-pos"></div>
                </div>

                <!-- Menu Tab -->
                <div id="tab-menu" style="display:none;">
                    <div class="card admin-only">
                        <h3>Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯</h3>
                        <input type="hidden" id="edit-id">
                        <input type="text" id="new-name" class="input" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù">
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <input type="number" id="new-price" class="input" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹">
                            <input type="number" id="new-cost" class="input" placeholder="Ø§Ù„ØªÙƒÙ„ÙØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                        </div>
                        
                        <!-- Dynamic Category Select -->
                        <label style="font-size:13px; font-weight:bold; display:block; margin-top:10px;">Ø§Ù„Ù‚Ø³Ù…:</label>
                        <select id="cat-select" class="input" onchange="toggleCatInput()">
                            <!-- Populated by JS -->
                        </select>
                        <input type="text" id="new-cat-name" class="input hidden" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯">

                        <label style="font-size:13px; font-weight:bold; margin-top:10px; display:block;">ØµÙˆØ±Ø© Ø§Ù„ØµÙ†Ù</label>
                        <input type="file" id="img-upload" class="input" accept="image/*" onchange="previewImage(this)">
                        <input type="hidden" id="current-img-url">
                        <div id="img-preview-container" style="margin-top:10px; display:none; align-items:center; gap:10px; padding:10px; background:#f9fafb; border-radius:8px;">
                            <img id="preview-tag" src="" style="width:60px; height:60px; object-fit:cover; border-radius:8px;">
                            <button class="btn btn-danger btn-sm" onclick="clearImage()">Ø­Ø°Ù Ø§Ù„ØµÙˆØ±Ø©</button>
                        </div>

                        <div style="margin-top:15px; display:flex; gap:10px;">
                            <button id="save-btn" class="btn btn-primary" style="flex:1" onclick="saveItem()">Ø­ÙØ¸ Ø§Ù„ØµÙ†Ù</button>
                            <button id="cancel-edit" class="btn btn-ghost hidden" onclick="resetForm()">Ø¥Ù„ØºØ§Ø¡</button>
                        </div>
                    </div>
                    <div id="menu-list"></div>
                </div>

                <!-- CATEGORIES Tab (New) -->
                <div id="tab-categories" style="display:none;">
                    <div class="card admin-only">
                        <h3>Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯</h3>
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="global-cat-input" class="input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… (Ù…Ø«Ø§Ù„: Ù…Ù‚Ø¨Ù„Ø§Øª)">
                            <button class="btn btn-primary" onclick="addGlobalCategory()">Ø¥Ø¶Ø§ÙØ©</button>
                        </div>
                    </div>
                    <div class="card">
                        <h3>Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h3>
                        <div id="categories-grid" class="grid-cats"></div>
                    </div>
                </div>

                <!-- Reports Tab -->
                <div id="tab-reports" style="display:none;">
                    <div class="grid-3" style="margin-bottom:20px;">
                        <div class="stat-card" style="border-top: 4px solid var(--success);">
                            <small style="color:var(--text-light)">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</small>
                            <span class="stat-val" id="report-sales" style="color:var(--success)">0</span> <small>Ø¬.Ù…</small>
                        </div>
                        <div class="stat-card" style="border-top: 4px solid var(--danger);">
                            <small style="color:var(--text-light)">Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ</small>
                            <span class="stat-val" id="report-cost" style="color:var(--danger)">0</span> <small>Ø¬.Ù…</small>
                        </div>
                        <div class="stat-card" style="border-top: 4px solid var(--primary);">
                            <small style="color:var(--text-light)">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</small>
                            <span class="stat-val" id="report-profit" style="color:var(--primary)">0</span> <small>Ø¬.Ù…</small>
                        </div>
                    </div>
                    <div class="card">
                        <h3>Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h3>
                        <div id="report-list" style="max-height:400px; overflow-y:auto;"></div>
                    </div>
                </div>

                <!-- Users Tab -->
                <div id="tab-users" style="display:none; padding: 10px;">
                    <div class="card" style="background: #fff; border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <h2 style="color: var(--primary); margin-bottom: 20px; text-align: center;">Ø¥Ø¯Ø§Ø±Ø© Ø·Ø§Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„</h2>

                        <!-- Ø®Ø§Ù†Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© -->
                        <div style="background: #f9fafb; padding: 15px; border-radius: 12px; margin-bottom: 25px;">
                            <input type="text" id="new-username" class="input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù…Ø«Ù„Ø§Ù‹: Ù…Ø­Ù…ÙˆØ¯)">
                            <input type="password" id="new-password" class="input" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                            <select id="new-user-role" class="input">
                                <option value="admin">Ù…Ø¯ÙŠØ± (ØµÙ„Ø§Ø­ÙŠØ§Øª ÙƒØ§Ù…Ù„Ø© Ø¨Ø¯ÙˆÙ† Ø­Ø°Ù Ø³Ø¬Ù„Ø§Øª)</option>
                                <option value="manager">Ù…ÙˆØ¸Ù ÙƒØ§Ø´ÙŠØ± (Ø¨ÙŠØ¹ ÙÙ‚Ø·)</option>
                            </select>
                            <button class="btn btn-success" style="width:100%; margin-top:10px; height: 50px;" onclick="addUser()">
                                <i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¢Ù†
                            </button>
                        </div>

                        <hr style="border: 0; border-top: 1px solid #eee; margin-bottom: 20px;">

                        <!-- Ø§Ù„Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø°ÙŠ Ø³ØªØ¸Ù‡Ø± ÙÙŠÙ‡ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ -->
                        <h3 style="margin-bottom:15px; font-size: 18px; color: #374151;">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ†:</h3>
                        <div id="users-list-container" style="min-height: 50px; background: #fff;">
                            <!-- Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§ Ø¥Ø¬Ø¨Ø§Ø±ÙŠØ§Ù‹ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Floating Cart -->
        <div id="pos-cart">
            <div>
                <small style="color:var(--text-light)">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</small>
                <div style="font-size:24px; font-weight:900; color:var(--primary);"><span id="pos-total">0</span> <small style="font-size:14px">Ø¬.Ù…</small></div>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn btn-danger" onclick="clearCart()"><i class="fas fa-trash"></i></button>
                <button class="btn btn-primary" onclick="submitOrder()">Ø¥Ø±Ø³Ø§Ù„ <i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

        <!-- History Modal -->
        <div id="history-modal">
            <div class="modal-box">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h3>Ø³Ø¬Ù„ Ø§Ù„Ø·Ø§ÙˆÙ„Ø© <span id="hist-table-name" style="color:var(--primary)"></span></h3>
                    <button class="btn btn-ghost" onclick="closeModal()" style="font-size:20px;"><i class="fas fa-times"></i></button>
                </div>
                <div id="hist-list" style="max-height:300px; overflow-y:auto;"></div>
                <div style="margin-top:20px; text-align:center; background:#f3f4f6; padding:15px; border-radius:12px;">
                    <small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ ØªØ­ØµÙŠÙ„ Ø§Ù„Ø·Ø§ÙˆÙ„Ø©: <strong id="hist-total" style="color:var(--success)">0</strong> Ø¬.Ù…</small>
                </div>
            </div>
        </div>

        <!-- Lock Screen -->
        <div id="lock-screen" style="background: rgba(0,0,0,0.95); display:none; flex-direction: column; color: white;">
            <i class="fas fa-lock" style="font-size:60px; color:var(--danger); margin-bottom:20px;"></i>
            <h2 style="color:var(--danger)">Ø§Ù„Ù†Ø¸Ø§Ù… Ù…ØºÙ„Ù‚</h2>
            <p id="lock-reason">ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</p>
    </div>

    <script>
        // 1. Ù…Ù†Ø¹ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙŠÙ…Ù†Ù‰ (Right Click)
        document.addEventListener('contextmenu', event => event.preventDefault());

        // 2. Ù…Ù†Ø¹ Ø§Ø®ØªØµØ§Ø±Ø§Øª Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (F12, Ctrl+Shift+I, Ctrl+U)
        document.onkeydown = function(e) {
            // Ù…Ù†Ø¹ F12
            if (e.keyCode == 123) return false;

            // Ù…Ù†Ø¹ Ctrl+Shift+I (Inspect)
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) return false;

            // Ù…Ù†Ø¹ Ctrl+Shift+J (Console)
            if (e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) return false;

            // Ù…Ù†Ø¹ Ctrl+U (View Source)
            if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false;

            // Ù…Ù†Ø¹ Ctrl+S (Save Page)
            if (e.ctrlKey && e.keyCode == 'S'.charCodeAt(0)) return false;
        };

        // 3. ØªØ¹Ø·ÙŠÙ„ Ø®Ø§ØµÙŠØ© Ø§Ù„Ø³Ø­Ø¨ ÙˆØ§Ù„Ø¥ÙÙ„Ø§Øª Ù„Ù„ØµÙˆØ± (Ù„Ø­Ù…Ø§ÙŠØ© ØµÙˆØ± Ø§Ù„Ù…Ù†ÙŠÙˆ)
        document.addEventListener('dragstart', event => event.preventDefault());

        // ØªØ­Ø°ÙŠØ± ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„
        setInterval(() => {
            console.clear();
            console.log("%cØªØ­Ø°ÙŠØ±!", "color: red; font-size: 50px; font-weight: bold;");
            console.log("%cÙ‡Ø°Ù‡ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ù…Ø®ØµØµØ© Ù„Ù„Ù…Ø·ÙˆØ±ÙŠÙ† ÙÙ‚Ø·. Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± Ø§Ù„Ù…ØµØ±Ø­ Ø¨Ù‡ ØªØ¹Ø±Ø¶Ùƒ Ù„Ù„Ù…Ø³Ø§Ø¡Ù„Ø© Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©.", "font-size: 20px;");
        }, 1000);
    </script>

    <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
            import { getDatabase, ref, set, get, push, onValue, update, remove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
            import { getStorage, uploadBytes, getDownloadURL, ref as sRef } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

            const firebaseConfig = {
                apiKey: "AIzaSyB1J7lSkqHHShPlkvtIUwpgmgsGqJ1uhJQ",
                authDomain: "sheikh-pro-61502.firebaseapp.com",
                projectId: "sheikh-pro-61502",
                storageBucket: "sheikh-pro-61502.firebasestorage.app",
                messagingSenderId: "388665698743",
                appId: "1:388665698743:web:7eca2bfc0223f9c1736032",
                measurementId: "G-5F3J5S68LP"
            };

            const app = initializeApp(firebaseConfig);
            const db = getDatabase(app);
            const storage = getStorage(app);

            let currentUser = null;
            let cart = [];
            let menuData = [];
            let allOrders = {};
            let allTables = {};
            let allUsers = [];
            let allCategories = []; // New State

            const $ = id => document.getElementById(id);

            // Clock
            setInterval(() => {
                const now = new Date();
                $('clock').innerText = now.toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit'});
            }, 1000);

            // UI Helpers
            window.toggleSidebar = () => $('sidebar').classList.toggle('show');
            $('sidebar').addEventListener('click', (e) => {
                if(e.target === $('sidebar') && window.innerWidth < 768) $('sidebar').classList.remove('show');
            });

            window.toggleCatInput = () => {
                const val = $('cat-select').value;
                if(val === 'new') {
                    $('new-cat-name').classList.remove('hidden');
                    $('new-cat-name').focus();
                } else {
                    $('new-cat-name').classList.add('hidden');
                }
            };

            // --- Login ---
            window.attemptLogin = async () => {
                const u = $('user').value.trim();
                const p = $('pass').value.trim();
                $('login-msg').innerText = "";

                if (u === 'admin' && p === '104289') {
                    currentUser = { username: 'admin', role: 'super-admin' };
                    loginSuccess();
                    ensureAdminExists().catch(() => {});
                    return;
                }

                try {
                    const snap = await get(ref(db, 'users'));
                    allUsers = snap.val() || [];
                    const user = allUsers.find(x => x.username === u && x.password === p);
                    if (user) {
                        currentUser = user;
                        loginSuccess();
                    } else {
                        $('login-msg').innerText = "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©";
                    }
                } catch (error) {
                    $('login-msg').innerText = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±";
                }
            };

            function loginSuccess() {
                localStorage.setItem('sheikh_user', JSON.stringify(currentUser));
                document.body.classList.remove('is-super-admin', 'is-admin');

                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø§Ù„Ùƒ (Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø±ÙŠ)
                if (currentUser.role === 'super-admin') {
                    document.body.classList.add('is-super-admin');
                    document.body.classList.add('is-admin');
                }
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø¯ÙŠØ± (ÙŠØ¶ÙŠÙ ÙˆÙŠØ¹Ø¯Ù„ Ù„ÙƒÙ† Ù„Ø§ ÙŠØ­Ø°Ù Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø§Ù„ÙŠØ©)
                else if (currentUser.role === 'admin') {
                    document.body.classList.add('is-admin');
                }

                $('login-page').classList.add('hidden');
                $('dashboard').style.display = 'flex';
                $('user-display-name').innerText = currentUser.username;
                startListening();
            }

            window.logout = () => {
                localStorage.removeItem('sheikh_user'); // Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„
                location.reload();
            };

            async function ensureAdminExists() {
                const snap = await get(ref(db, 'users'));
                if (!snap.exists() || (snap.val() && snap.val().length === 0)) {
                    await set(ref(db, 'users'), [{ username: 'admin', password: '123', role: 'super-admin' }]);
                }
                // Seed Categories if empty
                const catSnap = await get(ref(db, 'categories'));
                if(!catSnap.exists()) {
                    await set(ref(db, 'categories'), ['Ù…Ø´ÙˆÙŠØ§Øª', 'ÙˆØ¬Ø¨Ø§Øª', 'Ù…Ø´Ø±ÙˆØ¨Ø§Øª', 'Ø­Ù„ÙˆÙŠØ§Øª']);
                }
            }

            function startListening() {
                onValue(ref(db, 'config'), (snap) => {
                    const c = snap.val();
                    if(c && c.locked) {
                        $('lock-screen').style.display = 'flex';
                        $('lock-reason').innerText = c.reason || 'Ù…ØºÙ„Ù‚';
                    } else {
                        $('lock-screen').style.display = 'none';
                    }
                });

                onValue(ref(db, 'menu'), s => {
                    menuData = s.val() || [];
                    renderPosMenu();
                    renderMenuList();
                });

                onValue(ref(db, 'tables'), s => {
                    allTables = s.val() || {};
                    // Ø§Ù…Ø³Ø­ Ø³Ø·Ø± if(Object.keys(allTables).length === 0) seedTables();
                    populateTableSelect();
                });

                onValue(ref(db, 'orders'), s => {
                    allOrders = s.val() || {};
                    renderReports();
                    renderCashier();
                });

                // Listen to Categories
                onValue(ref(db, 'categories'), s => {
                    const data = s.val();
                    // Ø¯ÙŠ Ø£Ù‡Ù… Ø­ØªØ©: Ø¨Ù†Ø­ÙˆÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù…ØµÙÙˆÙØ© Ø¹Ø´Ø§Ù† Ø§Ù„Ù€ map ØªØ´ØªØºÙ„ ØµØ­
                    if (data) {
                        allCategories = Array.isArray(data) ? data : Object.values(data);
                    } else {
                        allCategories = [];
                    }
                    console.log("Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…ØªØ§Ø­Ø©:", allCategories);
                    renderCategoriesList(); // Ø±Ø³Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
                    populateCategorySelect(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù
                });

                onValue(ref(db, 'users'), (snapshot) => {
                    allUsers = snapshot.val() || [];
                    console.log("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØµÙ„Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±:", allUsers);
                    renderUsersList(); // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ù… ÙÙˆØ± ÙˆØµÙˆÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                });
            }

            // --- Categories Logic (New) ---
            function renderCategoriesList() {
                const grid = $('categories-grid');
                if (!grid) return;

                if (allCategories.length === 0) {
                    grid.innerHTML = '<p style="color:#999; padding:20px; grid-column: 1/-1; text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù… Ù…Ø¶Ø§ÙØ© Ø­Ø§Ù„ÙŠØ§Ù‹</p>';
                    return;
                }

                grid.innerHTML = allCategories.map(cat => `
                    <div class="cat-tag" style="display:flex; justify-content:space-between; align-items:center; padding:12px 15px; font-weight:bold; background: white; border-radius: 12px; border: 1px solid #eee; box-shadow: 0 2px 4px rgba(0,0,0,0.02);">
                        <span><i class="fas fa-tag" style="color:var(--primary); margin-left:8px;"></i> ${cat}</span>
                        <button class="btn btn-danger btn-sm" onclick="deleteGlobalCategory('${cat}')" style="width:30px; height:30px; padding:0; display:flex; align-items:center; justify-content:center; border-radius:8px;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `).join('');
            }

            function renderCategories() {
                const container = $('categories-container');
                if (!container) return;

                // Ø§Ù„Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ "Ø§Ù„ÙƒÙ„"
                let html = `<div class="cat-chip active" onclick="window.filterMenu('all')" id="cat-all">Ø§Ù„ÙƒÙ„</div>`;

                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù„ÙŠ Ø£Ù†Øª Ø¶ÙØªÙ‡Ø§ ÙÙŠ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
                allCategories.forEach(cat => {
                    if (cat) {
                        html += `
                            <div class="cat-chip" onclick="window.filterMenu('${cat}')" id="cat-${cat}">
                                ${cat}
                            </div>`;
                    }
                });

                container.innerHTML = html;
            }

            window.addGlobalCategory = async () => {
                try {
                    const val = $('global-cat-input').value.trim();
                    if(!val) return alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…");

                    // Ø¬Ù„Ø¨ Ø£Ø­Ø¯Ø« Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…Ø¨Ø§Ø´Ø±Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
                    const snap = await get(ref(db, 'categories'));
                    let currentCats = [];
                    if (snap.exists()) {
                        const data = snap.val();
                        currentCats = Array.isArray(data) ? data : Object.values(data);
                    }

                    if(currentCats.includes(val)) return alert("Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„");

                    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
                    currentCats.push(val);

                    // Ø­ÙØ¸ Ø§Ù„Ù…ØµÙÙˆÙØ© ÙƒØ§Ù…Ù„Ø© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ±ØªÙŠØ¨
                    await set(ref(db, 'categories'), currentCats);

                    $('global-cat-input').value = '';
                    alert("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù‚Ø³Ù… Ø¨Ù†Ø¬Ø§Ø­");
                } catch (error) {
                    console.error(error);
                    alert("âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±: " + error.message);
                }
            };

            window.deleteGlobalCategory = async (cat) => {
                if(!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‚Ø³Ù… "${cat}"ØŸ`)) return;
                try {
                    // ÙÙ„ØªØ±Ø© Ø§Ù„Ù…ØµÙÙˆÙØ© ÙˆØ­Ø°Ù Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
                    const updatedCats = allCategories.filter(c => c !== cat);

                    // Ø¥Ø¹Ø§Ø¯Ø© Ø±ÙØ¹ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø°Ù
                    await set(ref(db, 'categories'), updatedCats);
                    alert("ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ø­Ø°Ù");
                } catch (error) {
                    alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù: " + error.message);
                }
            };

            function populateCategorySelect() {
                const select = $('cat-select');
                // Keep existing value if possible
                const currentVal = select.value;
                
                select.innerHTML = allCategories.map(c => `<option value="${c}">${c}</option>`).join('') + `<option value="new">+ Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯...</option>`;
                
                // Restore value if it still exists in the list
                if(allCategories.includes(currentVal)) {
                    select.value = currentVal;
                }
            }

            async function seedTables() {
                const t = {};
                for(let i=1; i<=10; i++) t[i] = { id: i, name: `Ø·Ø§ÙˆÙ„Ø© ${i}`, occupied: false, total: 0 };
                await set(ref(db, 'tables'), t);
            }

            window.switchTab = (t) => {
                // Update Sidebar UI
                document.querySelectorAll('.menu-item').forEach(b => b.classList.remove('active'));
                if(event && event.currentTarget) event.currentTarget.classList.add('active');
                
                // Mobile: Close sidebar after click
                if(window.innerWidth < 768) $('sidebar').classList.remove('show');

                // Switch Content
                ['pos','cashier','menu','categories','reports','users'].forEach(x => $(`tab-${x}`).style.display = (x===t?'block':'none'));
                
                const titles = { pos: 'Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹', cashier: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ø§ÙˆÙ„Ø§Øª', menu: 'Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØ§Ù„Ù…Ø®Ø²ÙˆÙ†', categories: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…', reports: 'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©', users: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†' };
                $('page-title').innerText = titles[t];

                if(t==='cashier') renderCashier();
                if(t==='reports') renderReports();
            };

            function populateTableSelect() {
                const keys = Object.keys(allTables).sort((a,b) => a - b);
                $('pos-table').innerHTML = keys.map(k => {
                    const t = allTables[k];
                    const tableId = t.id || k;
                    const tableName = t.name || `Ø·Ø§ÙˆÙ„Ø© ${tableId}`;
                    return `<option value="${tableId}">${tableName}</option>`;
                }).join('');
            }

            // --- POS ---
            function renderPosMenu() {
                $('pos-menu-list').innerHTML = menuData.map(i => `
                    <div class="item-card ${i.available ? '' : 'unavailable'}" onclick="addToCart(${i.id})">
                        <img src="${i.img || 'https://via.placeholder.com/150'}" loading="lazy" style="width:80px; height:80px; border-radius:8px; object-fit:cover; margin-bottom:10px;">
                        <div style="font-weight:bold; font-size:14px; height:40px; overflow:hidden;">${i.name}</div>
                        <div style="color:var(--primary); font-weight:900; margin-top:auto;">${i.price} Ø¬.Ù…</div>
                    </div>`).join('');
            }
            
            window.addToCart = (id) => {
                const item = menuData.find(i => i.id === id);
                if(!item || !item.available) return alert("Ø§Ù„ØµÙ†Ù ØºÙŠØ± Ù…ØªØ§Ø­");
                const exist = cart.find(i => i.id === id);
                if(exist) exist.qty++; else cart.push({...item, qty:1});
                updateCartUI();
            };

            function updateCartUI() {
                const total = cart.reduce((s,i)=>s+(i.price*i.qty),0);
                $('pos-total').innerText = total;
                $('pos-cart').style.display = cart.length>0 ? 'flex' : 'none';
            }
            window.clearCart = () => { cart = []; updateCartUI(); };

            window.submitOrder = async () => {
                if(cart.length === 0) return;

                const selectedTable = $('pos-table').value;
                const totalAmount = cart.reduce((s,i)=>s+(i.price*i.qty),0);

                const orderData = {
                    tableId: selectedTable,
                    items: cart,
                    status: 'pending',
                    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                    time: new Date().toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit'}),
                    date: new Date().toLocaleDateString('ar-EG'),
                    user: currentUser ? currentUser.username : "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ",
                    total: totalAmount,
                    timestamp: Date.now()
                };

                try {
                    await push(ref(db, 'orders'), orderData);
                    await update(ref(db, `tables/${selectedTable}`), {
                        occupied: true,
                        lastOrderTime: Date.now()
                    });
                    cart = [];
                    updateCartUI();
                    alert('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨');
                } catch (e) {
                    alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø´Ø¨ÙƒØ©: " + e.message);
                }
            };

            // --- Cashier & Tables ---
            window.addNewTable = async () => {
                // 1. Ø¥Ø¶Ø§ÙØ© Ø­Ù…Ø§ÙŠØ© Ø¨Ø±Ù…Ø¬ÙŠØ© (ÙÙ‚Ø· Ù„Ù„Ù€ super-admin)
                if (currentUser.role !== 'super-admin') {
                    return alert("âš ï¸ Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø¥Ø¶Ø§ÙØ© Ø·Ø§ÙˆÙ„Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø§Ù„Ùƒ (Super Admin) ÙÙ‚Ø·");
                }

                if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¥Ø¶Ø§ÙØ© Ø·Ø§ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©ØŸ")) return;

                const keys = Object.keys(allTables).map(Number);
                const nextId = keys.length > 0 ? Math.max(...keys) + 1 : 1;
                const newTable = { id: nextId, name: `Ø·Ø§ÙˆÙ„Ø© ${nextId}`, occupied: false, total: 0 };

                try {
                    await update(ref(db, `tables/${nextId}`), newTable);
                    alert("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ø¨Ù†Ø¬Ø§Ø­");
                } catch (e) {
                    alert("Ø®Ø·Ø£: " + e.message);
                }
            };

            window.deleteTable = async (id) => {
                // Ù‡Ø°Ø§ Ø§Ù„Ø´Ø±Ø· ÙŠÙ…Ù†Ø¹ Ø£ÙŠ Ø±ØªØ¨Ø© ØºÙŠØ± "super-admin" Ù…Ù† Ø§Ù„ØªÙ†ÙÙŠØ° Ø­ØªÙ‰ Ù„Ùˆ Ø§Ø³ØªØ·Ø§Ø¹ Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø²Ø±
                if (currentUser.role !== 'super-admin') {
                    return alert("âš ï¸ Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø°Ù Ø§Ù„Ø·Ø§ÙˆÙ„Ø§Øª Ù…ØªØ§Ø­ ÙÙ‚Ø· Ù„Ù„Ù…Ø§Ù„Ùƒ (Super Admin)");
                }

                if(!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ`)) return;

                try {
                    await remove(ref(db, `tables/${id}`));
                    alert("ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ø§ÙˆÙ„Ø© Ø¨Ù†Ø¬Ø§Ø­");
                } catch (e) {
                    alert("Ø®Ø·Ø£: " + e.message);
                }
            };

            window.editTableName = async (id, currentName) => {
                const newName = prompt("ØªØºÙŠÙŠØ± Ø§Ø³Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø©:", currentName);
                if (!newName) return;

                try {
                    // Ù†Ø³ØªØ®Ø¯Ù… update Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø± tables/id Ù…Ø¨Ø§Ø´Ø±Ø©
                    // ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù€ id Ù‡Ù†Ø§ Ù‡Ùˆ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø£ØµÙ„ÙŠ Ù„Ù„Ø·Ø§ÙˆÙ„Ø© ÙÙŠ ÙØ§ÙŠØ±Ø¨ÙŠØ²
                    await update(ref(db, `tables/${id}`), {
                        name: newName
                    });
                    alert("âœ… ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„");
                } catch (e) {
                    alert("Ø®Ø·Ø£: " + e.message);
                }
            };

            window.showHistory = (tableId) => {
                const tableOrders = Object.values(allOrders).filter(o => o.tableId == tableId);
                tableOrders.sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0)); // ØªØ±ØªÙŠØ¨ Ù…Ù† Ø§Ù„Ø£Ø­Ø¯Ø«

                const modal = $('history-modal');
                const list = $('hist-list');

                $('hist-table-name').innerText = `(${tableId})`;
                const totalRevenue = tableOrders.reduce((sum, o) => o.status === 'paid' ? sum + o.total : sum, 0);
                $('hist-total').innerText = totalRevenue;

                if(tableOrders.length === 0) {
                    list.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª</div>';
                } else {
                    list.innerHTML = tableOrders.map(o => `
                        <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 0; border-bottom:1px solid #eee;">
                            <div>
                                <!-- Ø­Ù…Ø§ÙŠØ© Ø¶Ø¯ Ø§Ù„Ù€ undefined ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª -->
                                <div style="font-weight:bold;">${o.date || 'ØªØ§Ø±ÙŠØ® Ø³Ø§Ø¨Ù‚'} - ${o.time || ''}</div>
                                <div style="font-size:12px; color:#777;">Ø¨ÙˆØ§Ø³Ø·Ø©: ${o.user || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</div>
                            </div>
                            <div style="text-align:left;">
                                <div style="font-weight:bold;">${o.total} Ø¬.Ù…</div>
                                <span style="font-size:11px; padding:2px 8px; border-radius:10px; background:${o.status === 'paid' ? '#d1fae5' : '#fef3c7'}; color:${o.status === 'paid' ? '#065f46' : '#92400e'};">
                                    ${o.status === 'paid' ? 'ØªÙ… Ø§Ù„Ø¯ÙØ¹' : 'Ù†Ø´Ø·'}
                                </span>
                            </div>
                        </div>
                    `).join('');
                }
                modal.style.display = 'flex';
            };

            window.closeModal = () => $('history-modal').style.display = 'none';

            function renderCashier() {
                const keys = Object.keys(allTables).sort((a,b) => a - b);
                $('tables-grid').innerHTML = keys.map(k => {
                    const t = allTables[k];
                    const tableId = t.id || k;
                    const tableName = t.name || `Ø·Ø§ÙˆÙ„Ø© ${tableId}`;

                    const tableOrders = Object.values(allOrders).filter(o => o.tableId == tableId && o.status !== 'paid');
                    const bill = tableOrders.reduce((s,o)=>s+o.total,0);
                    const count = tableOrders.length;

                    return `
                    <div class="table-card ${bill > 0 ? 'active' : ''}">
                        <div>
                            <!-- Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø¬Ø¯ÙŠØ¯: Ø§Ø³Ù… Ø§Ù„Ø·Ø§ÙˆÙ„Ø© ÙˆØ¬Ù†Ø¨Ù‡ Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ -->
                            <div style="display:flex; align-items:center; justify-content:center; gap:8px; margin-bottom:10px;">
                                <h3 style="margin:0;">${tableName}</h3>
                                <button class="btn btn-ghost"
                                        style="padding:4px; font-size:12px; color:var(--primary); background:none; border:none;"
                                        onclick="editTableName(${k}, '${tableName}')"
                                        title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…">
                                    <i class="fas fa-pen"></i>
                                </button>
                            </div>

                            <div style="font-size:32px; font-weight:900; color:${bill > 0 ? 'var(--danger)' : '#ccc'};">
                                ${bill} <small style="font-size:14px;">Ø¬.Ù…</small>
                            </div>

                            <!-- Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ (Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø±) ÙŠÙØ¶Ù„ Ø²ÙŠ Ù…Ø§ Ù‡Ùˆ -->
                            <div style="font-size:12px; color:#777; margin-top:5px;">
                                <i class="fas fa-receipt"></i> ${count} Ø·Ù„Ø¨ Ù†Ø´Ø·
                            </div>
                        </div>

                        <div class="actions-container">
                            ${bill > 0 ? `<button class="btn btn-success" onclick="payTable(${tableId}, ${bill})"><i class="fas fa-check"></i> Ø¯ÙØ¹</button>` : ''}

                            <button class="btn btn-ghost" onclick="showHistory(${tableId})" title="Ø§Ù„Ø³Ø¬Ù„">
                                <i class="fas fa-history"></i>
                            </button>

                            <button class="btn btn-danger delete-btn" onclick="deleteTable(${tableId})" title="Ø­Ø°Ù">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>`;
                }).join('');
            }

            window.payTable = async (tid, amount) => {
                if(!confirm(`ØªØ£ÙƒÙŠØ¯ Ø§Ø³ØªÙ„Ø§Ù… Ù…Ø¨Ù„Øº ${amount} Ø¬.Ù…ØŸ`)) return;
                const updates = {};
                Object.entries(allOrders).forEach(([k, o]) => {
                    if(o.tableId === tid && o.status !== 'paid') {
                        updates[`orders/${k}/status`] = 'paid';
                        updates[`orders/${k}/paidBy`] = currentUser.username;
                    }
                });
                updates[`tables/${tid}/occupied`] = false;
                updates[`tables/${tid}/total`] = 0;
                await update(ref(db), updates);
                renderCashier();
            };

            // --- Reports ---
            window.deleteOrderRecord = async (orderKey) => {
                if (currentUser.role !== 'super-admin') {
                    return alert("âš ï¸ Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø°Ù Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø§Ù„Ùƒ ÙÙ‚Ø·");
                }
                if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) return;
                try {
                    await remove(ref(db, `orders/${orderKey}`));
                    alert("ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ø­Ø°Ù");
                } catch (e) { alert("Ø®Ø·Ø£: " + e.message); }
            };

            function renderReports() {
                // Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ù„Ù…ØµÙÙˆÙØ© Ù…Ø¹ Ù…ÙØ§ØªÙŠØ­Ù‡Ø§
                const ordersEntries = Object.entries(allOrders);
                const paidOrders = ordersEntries.filter(([key, o]) => o.status === 'paid');

                let totalSales = 0;
                let totalCost = 0;

                paidOrders.forEach(([key, order]) => {
                    totalSales += parseFloat(order.total) || 0;
                    if(order.items) {
                        order.items.forEach(item => {
                            const product = menuData.find(p => p.id == item.id);
                            if(product) totalCost += (parseFloat(product.cost) || 0) * item.qty;
                        });
                    }
                });

                $('report-sales').innerText = totalSales.toFixed(1);
                $('report-cost').innerText = totalCost.toFixed(1);
                $('report-profit').innerText = (totalSales - totalCost).toFixed(1);

                // Ø±Ø³Ù… Ø§Ù„Ø³Ø¬Ù„ Ù…Ø¹ Ø²Ø± Ø§Ù„Ø­Ø°Ù
                $('report-list').innerHTML = paidOrders.reverse().map(([key, o]) => `
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:12px; background:white; margin-bottom:8px; border-radius:12px; border:1px solid #eee; box-shadow:0 2px 4px rgba(0,0,0,0.02);">
                        <div style="display:flex; align-items:center; gap:12px;">
                            <div style="background:var(--primary-light); color:var(--primary); width:40px; height:40px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-weight:bold;">
                                ${o.tableId}
                            </div>
                            <div>
                                <strong style="display:block;">Ø·Ø§ÙˆÙ„Ø© ${o.tableId}</strong>
                                <small style="color:#777;">
                                    ${o.date || 'ØªØ§Ø±ÙŠØ® Ù‚Ø¯ÙŠÙ…'} | ${o.time || ''}
                                    ${o.user ? ' | Ø¨ÙˆØ§Ø³Ø·Ø©: ' + o.user : ''}
                                </small>
                            </div>
                        </div>
                        <div style="display:flex; align-items:center; gap:15px;">
                            <strong style="color:var(--success); font-size:16px;">${o.total} Ø¬.Ù…</strong>
                            <button class="delete-btn btn btn-ghost"
                                    style="color:var(--danger); padding:5px; background:none;"
                                    onclick="deleteOrderRecord('${key}')"
                                    title="Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }

            // --- Menu ---
            function renderMenuList() {
                const list = $('menu-list');
                if (!list) return;

                list.innerHTML = menuData.map(i => {
                    const isHidden = !i.available;
                    const btnToggleText = isHidden ? '<i class="fas fa-play"></i>' : '<i class="fas fa-pause"></i>';
                    const btnToggleClass = isHidden ? 'btn-success' : 'btn-warning';

                    // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªØ­ÙƒÙ… Ù„Ù„Ø£Ø¯Ù…Ù† ÙˆØ§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø£Ø¹Ù„Ù‰
                    const canEdit = currentUser.role === 'admin' || currentUser.role === 'super-admin';

                    return `
                    <div class="card" style="display:flex; justify-content:space-between; align-items:center; padding:15px; margin-bottom:10px; ${isHidden ? 'opacity:0.7; border-right: 5px solid #ccc;' : ''}">
                        <div style="display:flex; gap:12px; align-items:center;">
                            <img src="${i.img || 'https://via.placeholder.com/50'}" loading="lazy" style="width:55px; height:55px; border-radius:8px; object-fit:cover; background:#eee; border: 1px solid #ddd;">
                            <div>
                                <strong style="font-size:16px;">${i.name}</strong> <br>
                                <small style="color:#777;">${i.price} Ø¬.Ù… | <span style="color:var(--primary)">${i.cat}</span></small>
                            </div>
                        </div>

                        <div style="display:flex; gap:8px;">
                            <!-- Ø²Ø± Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù/Ø§Ù„ØªØ´ØºÙŠÙ„ (Ù…ØªØ§Ø­ Ù„Ù„Ø£Ø¯Ù…Ù†) -->
                            ${canEdit ? `<button class="btn ${btnToggleClass} btn-sm" onclick="toggleItem(${i.id})" title="Ø¥ÙŠÙ‚Ø§Ù/ØªÙØ¹ÙŠÙ„">${btnToggleText}</button>` : ''}

                            <!-- Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ -->
                            ${canEdit ? `<button class="btn btn-ghost btn-sm" style="color:blue; background:#eef;" onclick="editItem(${i.id})" title="ØªØ¹Ø¯ÙŠÙ„"><i class="fas fa-edit"></i></button>` : ''}

                            <!-- Ø²Ø± Ø§Ù„Ø­Ø°Ù (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø£Ø¹Ù„Ù‰ super-admin) -->
                            ${currentUser.role === 'super-admin' ?
                                `<button class="btn btn-danger btn-sm" onclick="deleteItem(${i.id})" title="Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ"><i class="fas fa-trash"></i></button>` : ''}
                        </div>
                    </div>`;
                }).join('');
            }

            window.saveItem = async () => {
                try {
                    const name = $('new-name').value.trim();
                    const price = parseFloat($('new-price').value);
                    const cost = parseFloat($('new-cost').value) || 0;
                    const cat = $('cat-select').value;
                    const editId = $('edit-id').value;

                    if(!name || isNaN(price) || !cat) return alert("ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©");

                    const saveBtn = $('save-btn');
                    saveBtn.innerText = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...";
                    saveBtn.disabled = true;

                    // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    const snap = await get(ref(db, 'menu'));
                    let data = snap.val();

                    // Ø§Ù„Ø­Ù„ Ù‡Ù†Ø§: Ø§Ù„ØªØ£ÙƒØ¯ 100% Ø¥Ù†Ù†Ø§ Ø¨Ù†ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ù…ØµÙÙˆÙØ©
                    let currentMenu = [];
                    if (data) {
                        // Ù„Ùˆ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§Ø¦Ù† (Object) Ø­ÙˆÙ„Ù‡Ø§ Ù„Ù…ØµÙÙˆÙØ©ØŒ Ù„Ùˆ Ù…ØµÙÙˆÙØ© Ø³ÙŠØ¨Ù‡Ø§ Ø²ÙŠ Ù…Ø§ Ù‡ÙŠ
                        currentMenu = Array.isArray(data) ? data : Object.values(data);
                    }

                    if(editId) {
                        // Ø­Ø§Ù„Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
                        const idx = currentMenu.findIndex(i => i && i.id == editId);
                        if(idx !== -1) {
                            currentMenu[idx] = {
                                ...currentMenu[idx],
                                name, price, cost, cat
                            };
                            if ($('current-img-url').value) currentMenu[idx].img = $('current-img-url').value;
                        }
                    } else {
                        // Ø­Ø§Ù„Ø© Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯ - Ø¯Ù„ÙˆÙ‚ØªÙŠ push Ù‡ØªØ´ØªØºÙ„ Ø£ÙƒÙŠØ¯
                        currentMenu.push({
                            id: Date.now(),
                            name,
                            price,
                            cost,
                            cat,
                            img: $('current-img-url').value || "https://via.placeholder.com/150",
                            available: true
                        });
                    }

                    // Ø­ÙØ¸ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù†Ø¶ÙŠÙØ©
                    await set(ref(db, 'menu'), currentMenu);
                    renderMenuList(); // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„ØªØ¸Ù‡Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙÙˆØ±Ø§Ù‹
                    renderPosMenu(); // ØªØ­Ø¯ÙŠØ« Ø´Ø§Ø´Ø© Ø§Ù„Ø¨ÙŠØ¹
                    resetForm();     // Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø®Ø§Ù†Ø§Øª

                    alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØµÙ†Ù Ø¨Ù†Ø¬Ø§Ø­");
                    saveBtn.innerText = "Ø­ÙØ¸ Ø§Ù„ØµÙ†Ù";
                    saveBtn.disabled = false;

                } catch (error) {
                    console.error(error);
                    alert("âŒ Ø®Ø·Ø£: " + error.message);
                    $('save-btn').disabled = false;
                    $('save-btn').innerText = "Ø­ÙØ¸ Ø§Ù„ØµÙ†Ù";
                }
            };

            window.deleteItem = async (id) => {
                if(!confirm("Ø­Ø°ÙØŸ")) return; 
                menuData = menuData.filter(i=>i.id!==id);
                await set(ref(db, 'menu'), menuData);
                renderMenuList(); renderPosMenu();
            };

            window.toggleItem = async (id) => {
                const item = menuData.find(i=>i.id === id); 
                if(item) {
                    item.available = !item.available;
                    renderMenuList();
                    renderPosMenu();
                    try {
                        await set(ref(db, 'menu'), menuData); 
                    } catch(e) { alert("Ø®Ø·Ø£"); }
                }
            };

            window.editItem = (id) => {
                const item = menuData.find(i => i.id === id);
                $('new-name').value = item.name;
                $('new-price').value = item.price;
                $('new-cost').value = item.cost || 0;
                
                const select = $('cat-select');
                // Populate categories first just in case
                populateCategorySelect();
                
                if(allCategories.includes(item.cat)) {
                    select.value = item.cat;
                    $('new-cat-name').classList.add('hidden');
                } else {
                    select.value = 'new';
                    $('new-cat-name').classList.remove('hidden');
                    $('new-cat-name').value = item.cat;
                }
                
                if(item.img) {
                    $('preview-tag').src = item.img;
                    $('img-preview-container').style.display = 'flex';
                    $('current-img-url').value = item.img;
                }
                $('edit-id').value = id;
            };

            window.resetForm = () => {
                $('new-name').value = ''; $('new-price').value = ''; $('new-cost').value = '';
                $('edit-id').value = ''; clearImage();
                $('cat-select').value = 'Ù…Ø´ÙˆÙŠØ§Øª';
                $('new-cat-name').classList.add('hidden');
            };

            window.addUser = async () => {
                const u = document.getElementById('new-username').value.trim();
                const p = document.getElementById('new-password').value.trim();
                const r = document.getElementById('new-user-role').value;

                if (!u || !p) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±");

                try {
                    // 1. Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ† Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… Ø§Ù„ØªÙƒØ±Ø§Ø±
                    const snapshot = await get(ref(db, 'users'));
                    let currentUsers = [];
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        currentUsers = Array.isArray(data) ? data : Object.values(data);
                    }

                    // 2. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
                    currentUsers.push({ username: u, password: p, role: r });

                    // 3. Ø§Ù„Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ± ÙƒÙ…ØµÙÙˆÙØ©
                    await set(ref(db, 'users'), currentUsers);

                    // 4. Ù…Ø³Ø­ Ø§Ù„Ø®Ø§Ù†Ø§Øª
                    document.getElementById('new-username').value = '';
                    document.getElementById('new-password').value = '';
                    alert("âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© " + u + " Ø¨Ù†Ø¬Ø§Ø­");

                } catch (error) {
                    alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±: " + error.message);
                }
            };

            function renderUsersList() {
                // 1. Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙƒØ§Ù† Ø§Ù„Ø¬Ø¯ÙŠØ¯
                const listContainer = document.getElementById('users-list-container');

                // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¹Ù†ØµØ± Ù…ÙˆØ¬ÙˆØ¯ ÙØ¹Ù„Ø§Ù‹
                if (!listContainer) {
                    console.error("Ù„Ù… Ø£Ø¬Ø¯ Ø¹Ù†ØµØ± users-list-container!");
                    return;
                }

                // 2. ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù…ØµÙÙˆÙØ©
                let dataToShow = [];
                if (allUsers) {
                    dataToShow = Array.isArray(allUsers) ? allUsers : Object.values(allUsers);
                }

                // 3. Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ© ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±
                if (dataToShow.length === 0) {
                    listContainer.innerHTML = `
                        <div style="text-align:center; padding:30px; border: 2px dashed #ccc; border-radius:10px; color:#999;">
                            <i class="fas fa-users-slash" style="font-size:30px; margin-bottom:10px;"></i>
                            <p>Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ© ØªÙ…Ø§Ù…Ø§Ù‹ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±.. Ø£Ø¶Ù Ù…ÙˆØ¸ÙØ§Ù‹ Ø§Ù„Ø¢Ù†</p>
                        </div>`;
                    return;
                }

                // 4. Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙƒÙˆØ¯ ÙˆØªÙØ±ÙŠØºÙ‡ ÙÙŠ Ø§Ù„ØµÙØ­Ø©
                let finalHtml = '';
                dataToShow.forEach((user, index) => {
                    if (user && user.username) {
                        let color = user.role === 'admin' ? '#2563eb' : '#4b5563';
                        let label = user.role === 'admin' ? 'Ù…Ø¯ÙŠØ±' : 'Ù…ÙˆØ¸Ù';

                        finalHtml += `
                            <div style="display:flex; justify-content:space-between; align-items:center; padding:15px; background:#fff; border:1px solid #eee; border-radius:10px; margin-bottom:10px; box-shadow: 0 2px 4px rgba(0,0,0,0.02);">
                                <div>
                                    <div style="font-weight:bold; font-size:16px; color:#111827;">${user.username}</div>
                                    <div style="font-size:12px; color:${color}; font-weight:bold;">${label}</div>
                                </div>
                                <div>
                                    ${user.role !== 'super-admin' ? `
                                        <button class="btn btn-danger" onclick="deleteUser(${index})" style="padding:8px 15px; border-radius:8px;">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    ` : '<span style="color:#10b981; font-size:12px;">Ø­Ø³Ø§Ø¨ Ù…Ø­Ù…ÙŠ</span>'}
                                </div>
                            </div>
                        `;
                    }
                });

                listContainer.innerHTML = finalHtml;
                console.log("ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©.");
            }

            window.deleteUser = async (index) => {
                if (allUsers[index].role === 'super-admin') {
                    alert("Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ø£Ø¹Ù„Ù‰!");
                    return;
                }

                if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… "${allUsers[index].username}"ØŸ`)) return;

                try {
                    allUsers.splice(index, 1); // Ø­Ø°Ù Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
                    await set(ref(db, 'users'), allUsers); // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    alert("ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
                } catch (e) {
                    alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù: " + e.message);
                }
            };

            async function uploadImage(file) {
                try {
                    const r = sRef(storage, `menu_images/${Date.now()}`);
                    await uploadBytes(r, file);
                    return await getDownloadURL(r);
                } catch (e) { console.error(e); return null; }
            }

            window.previewImage = async (input) => {
                if (input.files && input.files[0]) {
                    const file = input.files[0];

                    // Ø¥Ø¸Ù‡Ø§Ø± ØµÙˆØ±Ø© Ù…Ø¤Ù‚ØªØ© Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        $('preview-tag').src = e.target.result;
                        $('img-preview-container').style.display = 'flex';
                    };
                    reader.readAsDataURL(file);

                    // Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© ÙØ¹Ù„ÙŠØ§Ù‹ Ù„Ù€ Firebase Storage
                    try {
                        const url = await uploadImage(file);
                        if (url) {
                            $('current-img-url').value = url; // Ù†Ø¶Ø¹ Ø§Ù„Ø±Ø§Ø¨Ø· ÙÙŠ Ø§Ù„Ù€ input Ø§Ù„Ù…Ø®ÙÙŠ
                            console.log("Image uploaded to:", url);
                        }
                    } catch (e) {
                        alert("Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©");
                    }
                }
            };
            window.clearImage = () => {
                $('img-upload').value = ''; $('current-img-url').value = '';
                $('img-preview-container').style.display = 'none';
            }

            // Ø§Ù„ÙƒÙˆØ¯ Ø¯Ù‡ Ø¨ÙŠØ´ØªØºÙ„ Ø£ÙˆÙ„ Ù…Ø§ Ø§Ù„ØµÙØ­Ø© ØªØ­Ù…Ù„
            window.onload = () => {
                const savedUser = localStorage.getItem('sheikh_user');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    loginSuccess();
                }
            };
        </script>
    </body>
    </html>
